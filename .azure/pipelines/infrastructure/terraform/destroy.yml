trigger: none

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: online-boutique.common    # Common variables (like AZURE_SUBSCRIPTION)
  - group: terraform.infrastructure  # Infrastructure-specific variables

stages:
- stage: Setup
  displayName: 'Setup Environment'
  jobs:
  - job: SetupTerraform
    displayName: 'Setup Terraform'
    steps:
    - template: ../../templates/terraform/setup-terraform.yml

- stage: Validate
  displayName: 'Validate Terraform'
  dependsOn: Setup
  jobs:
  - job: Validate
    displayName: 'Terraform Validate'
    steps:
    - template: ../../templates/terraform/terraform.yml
      parameters:
        workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/bootstrap'
        command: 'validate'

# Destroy stage requires manual approval in the 'infrastructure' environment
- stage: Destroy
  displayName: 'Destroy Infrastructure'
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - deployment: Destroy
    displayName: 'Terraform Destroy'
    environment: 'infrastructure'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../../templates/terraform/terraform.yml
            parameters:
              workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/bootstrap'
              command: 'apply'
              destroy: true 