trigger:
  branches:
    include:
      - main
  paths:
    include:
      - terraform/application/**

pr: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: online-boutique.common    # Common variables (like AZURE_SUBSCRIPTION)
  - group: terraform.application     # Application-specific variables

stages:
- stage: Validate
  displayName: 'Validate Terraform'
  jobs:
  - template: ../../templates/terraform/validate.yml
    parameters:
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/application'

- stage: Plan
  displayName: 'Plan Changes'
  dependsOn: Validate
  condition: succeeded()
  jobs:
  - template: ../../templates/terraform/plan.yml
    parameters:
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/application'

# Apply stage requires manual approval in the 'application' environment
- stage: Apply
  displayName: 'Apply Changes'
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - template: ../../templates/terraform/apply.yml
    parameters:
      workingDirectory: '$(System.DefaultWorkingDirectory)/terraform/application'
      environment: 'application' 