parameters:
  workingDirectory: ''  # Directory containing Terraform files
  command: ''  # validate, plan, apply, or destroy

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: 'latest'

- task: AzureCLI@2
  displayName: 'Run Terraform Command'
  inputs:
    azureSubscription: $(AZURE_SUBSCRIPTION)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    workingDirectory: ${{ parameters.workingDirectory }}
    inlineScript: |
      set -e

      # Check required parameters
      if [ -z "${{ parameters.workingDirectory }}" ]; then
        echo "Error: workingDirectory parameter is required"
        exit 1
      fi

      if [ -z "${{ parameters.command }}" ]; then
        echo "Error: command parameter is required"
        exit 1
      fi

      # Initialize Terraform
      echo "Initializing Terraform..."
      terraform init -reconfigure

      # Execute Terraform command
      case "${{ parameters.command }}" in
        validate)
          echo "Validating Terraform configuration..."
          terraform validate
          ;;
        plan)
          echo "Creating Terraform plan..."
          terraform plan
          ;;
        apply)
          echo "Applying Terraform changes..."
          terraform apply
          ;;
        destroy)
          echo "Destroying Terraform infrastructure..."
          terraform destroy
          ;;
        *)
          echo "Error: Invalid command '${{ parameters.command }}'. Must be one of: validate, plan, apply, destroy"
          exit 1
          ;;
      esac