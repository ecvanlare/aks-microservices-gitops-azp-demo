parameters:
  workingDirectory: ''
  backendConfig: ''
  command: ''  # validate, plan, apply, or destroy

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: 'latest'

- task: AzureCLI@2
  displayName: 'Run Terraform Command'
  inputs:
    azureSubscription: $(AZURE_SUBSCRIPTION)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    workingDirectory: ${{ parameters.workingDirectory }}
    inlineScript: |
        set -e

        echo "Writing backend config to backend.tfbackend..."
        cat <<EOF > backend.tfbackend
        storage_account_name=$STORAGE_ACCOUNT_NAME
        container_name=$CONTAINER_NAME
        key=$TERRAFORM_STATE_KEY
        resource_group_name=$RESOURCE_GROUP_NAME
        EOF

        echo "Initializing Terraform..."
        terraform init -backend-config=backend.tfbackend -reconfigure

      case "${{ parameters.command }}" in
        validate)
          terraform validate
          ;;
        plan)
          terraform plan -out=tfplan
          ;;
        apply)
          terraform apply -auto-approve tfplan
          ;;
        destroy)
          terraform destroy -auto-approve
          ;;
        *)
          echo "Invalid command: ${{ parameters.command }}"
          exit 1
          ;;
      esac