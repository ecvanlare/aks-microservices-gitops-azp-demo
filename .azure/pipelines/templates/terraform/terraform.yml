parameters:
  workingDirectory: ''
  backendConfig: ''
  command: ''  # validate, plan, apply, or destroy

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: 'latest'

- task: AzureCLI@2
  displayName: 'Run Terraform Command'
  inputs:
    azureSubscription: $(AZURE_SUBSCRIPTION)
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    workingDirectory: ${{ parameters.workingDirectory }}
    inlineScript: |
      terraform init -backend-config="${{ parameters.backendConfig }}"
      if [ "${{ parameters.command }}" == "validate" ]; then
        terraform validate
      elif [ "${{ parameters.command }}" == "plan" ]; then
        terraform plan -out=tfplan
      elif [ "${{ parameters.command }}" == "apply" ]; then
        terraform apply -auto-approve tfplan
      elif [ "${{ parameters.command }}" == "destroy" ]; then
        terraform destroy -auto-approve
      fi 