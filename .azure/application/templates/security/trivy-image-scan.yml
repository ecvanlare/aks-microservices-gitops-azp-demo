parameters:
  imageName: ''
  imageTag: ''
  registryUrl: ''
  failOnHigh: false
  severityThreshold: 'CRITICAL' # CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN

steps:
- task: Docker@2
  displayName: 'Login to container registry'
  inputs:
    command: 'login'
    containerRegistry: '$(ACR_NAME)'

- task: trivy@2
  name: TrivyImageScan
  displayName: 'Trivy Image Security Scan - ${{ parameters.imageName }}'
  inputs:
    version: 'latest'
    type: 'image'
    target: '${{ parameters.registryUrl }}/${{ parameters.imageName }}:${{ parameters.imageTag }}'
    scanners: 'misconfig,vuln,secret'
    severity: '${{ parameters.severityThreshold }}'
    ignoreUnfixed: true
    ignoreScanErrors: true
    reports: 'html,junit,sarif'
    publish: true

- task: PublishTestResults@2
  displayName: 'Publish Trivy Image Test Results - ${{ parameters.imageName }}'
  condition: always()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '$(TrivyImageScan.junitReport)'
    searchFolder: '$(Agent.TempDirectory)'
    testRunTitle: 'Trivy Image Scan - ${{ parameters.imageName }}'
    publishRunAttachments: false 