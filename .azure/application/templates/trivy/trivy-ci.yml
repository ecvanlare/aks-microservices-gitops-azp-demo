parameters:
  scanPath: '.'
  failOnHigh: false
  severityThreshold: 'CRITICAL' # CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN

steps:
- task: trivy@2
  name: TrivySourceScan
  displayName: 'Scan source code for vulnerabilities'
  inputs:
    version: 'latest'
    type: 'filesystem'
    target: '${{ parameters.scanPath }}'
    scanners: 'misconfig,vuln,secret'
    severity: '${{ parameters.severityThreshold }}'
    ignoreUnfixed: true
    ignoreScanErrors: true
    reports: 'html,junit,sarif'
    publish: true

- task: PublishTestResults@2
  displayName: 'Publish Trivy Test Results'
  condition: always()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '$(TrivySourceScan.junitReport)'
    searchFolder: '$(Agent.TempDirectory)'
    testRunTitle: 'Trivy Security Scan'
    publishRunAttachments: false 