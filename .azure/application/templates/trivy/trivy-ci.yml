parameters:
  scanPath: '.'
  failOnHigh: true
  severityThreshold: 'HIGH' # CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN

steps:
- task: trivy@2
  displayName: 'Trivy Source Code Security Scan'
  inputs:
    type: 'filesystem'
    target: '${{ parameters.scanPath }}'
    scanners: 'vuln,misconfig,secret'
    severity: '${{ parameters.severityThreshold }},CRITICAL'
    format: 'json'
    outputFile: 'trivy-ci-results.json'
    exitCode: '0'
    ignoreUnfixed: false
    vulnType: 'os,library'
    securityChecks: 'vuln,config,secret'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Trivy CI Report'
  condition: always()
  inputs:
    PathtoPublish: 'trivy-ci-results.json'
    ArtifactName: 'TrivyCIReport' 