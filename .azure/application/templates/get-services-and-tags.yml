# Get Services and Tags Template
# Extracts services from DetectChanges stage and formats them with semver tags

parameters:
  # Input values (passed from the calling stage)
  servicesFromDetectChanges: ''  # Services from DetectChanges stage
  semver: ''  # Semantic version from GitVersion
  
  # Output variable name for the formatted services
  outputVariableName: 'SERVICES_TO_BUILD_FIXED'

steps:
  - script: |
      echo "Getting services and tags..."
      echo "Services from DetectChanges: '${{ parameters.servicesFromDetectChanges }}'"
      echo "Semver: '${{ parameters.semver }}'"
      
      # Convert services to service:tag format
      BUILT_SERVICES_WITH_TAGS=""
      if [ -n "${{ parameters.servicesFromDetectChanges }}" ] && [ -n "${{ parameters.semver }}" ]; then
        # Split services by space and add semver to each
        for service in ${{ parameters.servicesFromDetectChanges }}; do
          if [ -n "$service" ]; then
            BUILT_SERVICES_WITH_TAGS="$BUILT_SERVICES_WITH_TAGS $service:${{ parameters.semver }}"
          fi
        done
      fi
      
      # Trim leading space
      BUILT_SERVICES_WITH_TAGS=$(echo "$BUILT_SERVICES_WITH_TAGS" | sed 's/^ *//')
      
      echo "Built services with tags: '$BUILT_SERVICES_WITH_TAGS'"
      echo "##vso[task.setvariable variable=${{ parameters.outputVariableName }}]$BUILT_SERVICES_WITH_TAGS"
    displayName: 'Get Services and Tags' 