# Deploy Tasks Template
# Contains all deployment-related functionality in one organized file

parameters:
  # User-configurable deployment settings
  namespace: $(NAMESPACE)
  releaseName: $(RELEASE_NAME)
  includeVerification: true
  semver: ''  # Semantic version for deployment (passed from pipeline)
  chartPath: 'helm-charts/app-chart'
  valuesFile: 'values.yaml'

  # Deployment configuration
  vmImage: 'ubuntu-22.04'
  helmVersion: '3.12.0'
  helmTimeout: '10m'
  podReadyTimeout: 300
  clusterName: $(AKS_CLUSTER_NAME)

  # Azure configuration
  acrName: $(ACR_NAME)  # Required: ACR name
  resourceGroup: $(RESOURCE_GROUP)  # Required: Resource group name
  azureSubscription: $(AZURE_SUBSCRIPTION)  # Required: Azure subscription service connection

steps:
  # ========================================
  # SECTION 1: HELM DEPLOYMENT
  # ========================================
  - checkout: self
    fetchDepth: 0

  - template: helm/helm-deploy.yml
    parameters:
      clusterName: $(AKS_CLUSTER_NAME)
      resourceGroup: $(RESOURCE_GROUP)
      namespace: ${{ parameters.namespace }}
      chartPath: ${{ parameters.chartPath }}
      releaseName: ${{ parameters.releaseName }}
      valuesFile: ${{ parameters.valuesFile }}
      helmVersion: ${{ parameters.helmVersion }}
      helmTimeout: ${{ parameters.helmTimeout }}
      azureSubscription: $(AZURE_SUBSCRIPTION)
      semver: ${{ parameters.semver }}

  # ========================================
  # SECTION 2: DEPLOYMENT VERIFICATION
  # ========================================
  - ${{ if eq(parameters.includeVerification, 'true') }}:
    - task: AzureCLI@2
      displayName: 'Verify Deployment Status'
      inputs:
        azureSubscription: $(AZURE_SUBSCRIPTION)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -e
          
          # Get AKS credentials and configure kubelogin
          az aks get-credentials -n $(AKS_CLUSTER_NAME) -g $(RESOURCE_GROUP) --overwrite-existing
          kubelogin convert-kubeconfig -l azurecli
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=${{ parameters.releaseName }} -n ${{ parameters.namespace }} --timeout=${{ parameters.podReadyTimeout }}s
          
          # Display deployment status
          kubectl get pods -n ${{ parameters.namespace }} -l app.kubernetes.io/instance=${{ parameters.releaseName }}
          kubectl get services -n ${{ parameters.namespace }} -l app.kubernetes.io/instance=${{ parameters.releaseName }}
          kubectl get deployments -n ${{ parameters.namespace }} -l app.kubernetes.io/instance=${{ parameters.releaseName }}
          
          # Show image tags
          kubectl get pods -n ${{ parameters.namespace }} -l app.kubernetes.io/instance=${{ parameters.releaseName }} -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}' 