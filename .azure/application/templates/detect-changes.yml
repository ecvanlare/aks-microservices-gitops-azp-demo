# Detect Changes Template
# Contains all change detection functionality in one organized file

parameters:
  # Git configuration
  gitDepth: 0  # Number of commits to look back
  sourceDir: 'src'  # Source directory to monitor

steps:
  - script: |
      echo "=== Detect Changed Services ==="
      echo "Depth: ${{ parameters.gitDepth }}"

      # Define all services directly
      ALL_SERVICES="cartservice,frontend,productcatalogservice,currencyservice,emailservice,paymentservice,shippingservice,recommendationservice,adservice,checkoutservice,shoppingassistantservice"
      echo "All services: $ALL_SERVICES"
      IFS=',' read -ra SERVICES <<< "$ALL_SERVICES"

      # Define service paths directly
      declare -A SERVICE_PATHS
      SERVICE_PATHS["cartservice"]="src/cartservice/"
      SERVICE_PATHS["frontend"]="src/frontend/"
      SERVICE_PATHS["productcatalogservice"]="src/productcatalogservice/"
      SERVICE_PATHS["currencyservice"]="src/currencyservice/"
      SERVICE_PATHS["emailservice"]="src/emailservice/"
      SERVICE_PATHS["paymentservice"]="src/paymentservice/"
      SERVICE_PATHS["shippingservice"]="src/shippingservice/"
      SERVICE_PATHS["recommendationservice"]="src/recommendationservice/"
      SERVICE_PATHS["adservice"]="src/adservice/"
      SERVICE_PATHS["checkoutservice"]="src/checkoutservice/"
      SERVICE_PATHS["shoppingassistantservice"]="src/shoppingassistantservice/"

      echo "Service paths:"
      for service in "${!SERVICE_PATHS[@]}"; do
        echo "  $service: ${SERVICE_PATHS[$service]}"
      done

      # Get changed files
      if [ "${{ parameters.gitDepth }}" -eq 0 ]; then
        CHANGED_FILES=$(git diff --name-only HEAD~1)
      else
        CHANGED_FILES=$(git diff --name-only HEAD~${{ parameters.gitDepth }})
      fi

      echo "Changed files:"
      echo "$CHANGED_FILES"

      SERVICES_TO_BUILD=""
      for service in "${!SERVICE_PATHS[@]}"; do
        path="${SERVICE_PATHS[$service]}"
        echo "Checking service: $service with path: $path"
        
        # Check if service path has changes
        if echo "$CHANGED_FILES" | grep -q "$path"; then
          echo "✅ $service has changes"
          echo "##vso[task.setvariable variable=BUILD_${service^^};isOutput=true]true"
          SERVICES_TO_BUILD="$SERVICES_TO_BUILD $service"
        else
          echo "❌ $service has no changes"
          echo "##vso[task.setvariable variable=BUILD_${service^^};isOutput=true]false"
        fi
      done

      # Trim leading space and set final variable
      SERVICES_TO_BUILD=$(echo "$SERVICES_TO_BUILD" | sed 's/^ *//')
      echo "##vso[task.setvariable variable=SERVICES_TO_BUILD;isOutput=true]$SERVICES_TO_BUILD"
      echo "Services to build: $SERVICES_TO_BUILD"
    displayName: 'Detect Changed Services'
    name: DetectChanges