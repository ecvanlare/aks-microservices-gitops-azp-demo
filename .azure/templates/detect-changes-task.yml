parameters:
  gitDepth: 1  # Number of commits to look back
  sourceDir: 'src'  # Source directory to monitor
  chartDir: 'online-boutique-chart'  # Helm chart directory to monitor
  services:  # Optional: Override default services
    - name: 'cartservice'
      path: 'src/cartservice/'
      dependencies: []
    - name: 'frontend'
      path: 'src/frontend/'
      dependencies: []
    - name: 'productcatalogservice'
      path: 'src/productcatalogservice/'
      dependencies: []
    - name: 'currencyservice'
      path: 'src/currencyservice/'
      dependencies: []
    - name: 'emailservice'
      path: 'src/emailservice/'
      dependencies: []
    - name: 'paymentservice'
      path: 'src/paymentservice/'
      dependencies: []
    - name: 'shippingservice'
      path: 'src/shippingservice/'
      dependencies: []
    - name: 'recommendationservice'
      path: 'src/recommendationservice/'
      dependencies: ['productcatalogservice']
    - name: 'adservice'
      path: 'src/adservice/'
      dependencies: []
    - name: 'checkoutservice'
      path: 'src/checkoutservice/'
      dependencies: ['cartservice', 'paymentservice']
    - name: 'shoppingassistantservice'
      path: 'src/shoppingassistantservice/'
      dependencies: []

steps:
  - checkout: self
    fetchDepth: ${{ parameters.gitDepth }}

  - script: |
      echo "=== Change Detection for Online Boutique ==="
      echo "Git depth: ${{ parameters.gitDepth }}"
      echo "Source directory: ${{ parameters.sourceDir }}"
      echo "Chart directory: ${{ parameters.chartDir }}"
      echo "============================================="
      
      # Get list of changed files
      CHANGED_FILES=$(git diff --name-only HEAD~${{ parameters.gitDepth }})
      echo "Changed files:"
      echo "$CHANGED_FILES"
      echo ""
      
      # Initialize services to build
      SERVICES_TO_BUILD=""
      CHANGED_SERVICES=""
      
      # Check each service for changes
      echo "=== Checking Service Changes ==="
      ${{ each service in parameters.services }}:
        echo "Checking service: ${{ service.name }}"
        if echo "$CHANGED_FILES" | grep -q "${{ service.path }}"; then
          echo "  ‚úÖ ${{ service.name }} has changes"
          CHANGED_SERVICES="$CHANGED_SERVICES ${{ service.name }}"
          SERVICES_TO_BUILD="$SERVICES_TO_BUILD ${{ service.name }}"
        else
          echo "  ‚ùå ${{ service.name }} has no changes"
        fi
      
      echo ""
      echo "=== Resolving Dependencies ==="
      
      # Resolve service dependencies
      ${{ each service in parameters.services }}:
        if echo "$CHANGED_SERVICES" | grep -q "${{ service.name }}"; then
          echo "Checking dependencies for ${{ service.name }}"
          ${{ each dep in service.dependencies }}:
            if ! echo "$SERVICES_TO_BUILD" | grep -q "${{ dep }}"; then
              echo "  ‚ûï Adding dependency: ${{ dep }}"
              SERVICES_TO_BUILD="$SERVICES_TO_BUILD ${{ dep }}"
            else
              echo "  ‚úÖ Dependency already included: ${{ dep }}"
            fi
        fi
      
      echo ""
      echo "=== Checking Infrastructure Changes ==="
      
      # Check for infrastructure changes
      if echo "$CHANGED_FILES" | grep -q "${{ parameters.chartDir }}/"; then
        echo "‚úÖ Infrastructure changes detected in ${{ parameters.chartDir }}/"
        echo "üîÑ Building all services for infrastructure update"
        SERVICES_TO_BUILD="all"
      else
        echo "‚ùå No infrastructure changes detected"
      fi
      
      # Remove duplicates and trim whitespace
      SERVICES_TO_BUILD=$(echo "$SERVICES_TO_BUILD" | tr ' ' '\n' | sort -u | tr '\n' ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
      
      echo ""
      echo "=== Final Results ==="
      echo "Changed services: $CHANGED_SERVICES"
      echo "Services to build: $SERVICES_TO_BUILD"
      echo "====================================="
      
      # Set output variables
      echo "##vso[task.setvariable variable=SERVICES_TO_BUILD;isOutput=true]$SERVICES_TO_BUILD"
      echo "##vso[task.setvariable variable=CHANGED_SERVICES;isOutput=true]$CHANGED_SERVICES"
      echo "##vso[task.setvariable variable=CHANGED_FILES;isOutput=true]$CHANGED_FILES"
      
      # Set individual service flags for easier condition checking
      ${{ each service in parameters.services }}:
        if echo "$SERVICES_TO_BUILD" | grep -q "${{ service.name }}"; then
          echo "##vso[task.setvariable variable=BUILD_${{ upper(service.name) }};isOutput=true]true"
        else
          echo "##vso[task.setvariable variable=BUILD_${{ upper(service.name) }};isOutput=true]false"
        fi
      
      # Set infrastructure flag
      if echo "$SERVICES_TO_BUILD" | grep -q "all"; then
        echo "##vso[task.setvariable variable=BUILD_ALL;isOutput=true]true"
      else
        echo "##vso[task.setvariable variable=BUILD_ALL;isOutput=true]false"
      fi
      
    displayName: 'Detect Changed Services'
    name: DetectChanges 