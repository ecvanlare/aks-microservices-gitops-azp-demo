parameters:
  name: 'GitVersion'  # Name for the GitVersion task output
  fetchDepth: 0  # Git fetch depth for version calculation
  useConfigFile: false  # Whether to use GitVersion config file

steps:
  - script: |
      echo "=== Installing GitVersion ==="
      dotnet tool install --global GitVersion.Tool --version 5.12.0
      echo "GitVersion installed successfully"
    displayName: 'Install GitVersion'

  - script: |
      echo "=== Running GitVersion ==="
      GITVERSION_OUTPUT=$(dotnet gitversion /output json)
      echo "GitVersion output: $GITVERSION_OUTPUT"
      
      # Parse JSON output using jq (if available) or basic parsing
      if command -v jq &> /dev/null; then
        SEMVER=$(echo "$GITVERSION_OUTPUT" | jq -r '.SemVer')
        FULL_SEMVER=$(echo "$GITVERSION_OUTPUT" | jq -r '.FullSemVer')
        MAJOR_MINOR_PATCH=$(echo "$GITVERSION_OUTPUT" | jq -r '.MajorMinorPatch')
        COMMIT_SHA=$(echo "$GITVERSION_OUTPUT" | jq -r '.Sha')
        BRANCH_NAME=$(echo "$GITVERSION_OUTPUT" | jq -r '.BranchName')
      else
        # Basic parsing without jq
        SEMVER=$(echo "$GITVERSION_OUTPUT" | grep -o '"SemVer":"[^"]*"' | cut -d'"' -f4)
        FULL_SEMVER=$(echo "$GITVERSION_OUTPUT" | grep -o '"FullSemVer":"[^"]*"' | cut -d'"' -f4)
        MAJOR_MINOR_PATCH=$(echo "$GITVERSION_OUTPUT" | grep -o '"MajorMinorPatch":"[^"]*"' | cut -d'"' -f4)
        COMMIT_SHA=$(echo "$GITVERSION_OUTPUT" | grep -o '"Sha":"[^"]*"' | cut -d'"' -f4)
        BRANCH_NAME=$(echo "$GITVERSION_OUTPUT" | grep -o '"BranchName":"[^"]*"' | cut -d'"' -f4)
      fi
      
      echo "=== Parsed GitVersion Results ==="
      echo "SemVer: $SEMVER"
      echo "FullSemVer: $FULL_SEMVER"
      echo "MajorMinorPatch: $MAJOR_MINOR_PATCH"
      echo "Sha: $COMMIT_SHA"
      echo "BranchName: $BRANCH_NAME"
      echo "================================"
      
      # Set output variables for use in other stages
      echo "##vso[task.setvariable variable=SEMVER;isOutput=true]$SEMVER"
      echo "##vso[task.setvariable variable=FULL_SEMVER;isOutput=true]$FULL_SEMVER"
      echo "##vso[task.setvariable variable=MAJOR_MINOR_PATCH;isOutput=true]$MAJOR_MINOR_PATCH"
      echo "##vso[task.setvariable variable=COMMIT_SHA;isOutput=true]$COMMIT_SHA"
      echo "##vso[task.setvariable variable=BRANCH_NAME;isOutput=true]$BRANCH_NAME"
    name: SetVersionOutputs
    displayName: 'Run GitVersion and Set Output Variables' 