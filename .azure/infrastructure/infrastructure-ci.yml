# Infrastructure CI pipeline - validates and plans changes
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - terraform/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - terraform/**
      
pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: online-boutique.common
  - group: online-boutique.infrastructure
  - name: TERRAFORM_DIR
    value: '$(System.DefaultWorkingDirectory)/terraform'
  - name: TERRAFORM_TEMPLATE
    value: 'templates/terraform.yml'

jobs:
- job: Format
  displayName: 'Check Terraform Formatting'
  steps:
  - checkout: self
    path: terraform
  - template: ${{ variables.TERRAFORM_TEMPLATE }}
    parameters:
      workingDirectory: '$(TERRAFORM_DIR)'
      command: 'fmt'

- job: Validate
  displayName: 'Infrastructure Validate'
  dependsOn: Format
  condition: succeeded()
  steps:
  - checkout: self
    path: terraform
  - template: ${{ variables.TERRAFORM_TEMPLATE }}
    parameters:
      workingDirectory: '$(TERRAFORM_DIR)'
      command: 'validate'

- job: Plan
  displayName: 'Infrastructure Plan'
  dependsOn: Validate
  condition: succeeded()
  steps:
  - checkout: self
    path: terraform
  - template: ${{ variables.TERRAFORM_TEMPLATE }}
    parameters:
      workingDirectory: '$(TERRAFORM_DIR)'
      command: 'plan' 